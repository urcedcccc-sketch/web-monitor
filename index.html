<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›‘æµ‹æ§åˆ¶å° - ä¿®å¤å¢å¼ºç‰ˆ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 550px; margin: 40px auto; padding: 20px; background: #f6f8fa; color: #24292f; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 8px 24px rgba(149, 157, 165, 0.2); border: 1px solid #d0d7de; }
        h3 { margin-top: 0; color: #0969da; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        input { width: 100%; padding: 12px; border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: border-color 0.2s; }
        input:focus { border-color: #0969da; outline: none; box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3); }
        button { width: 100%; padding: 12px; background: #2da44e; color: white; border: 1px solid rgba(27, 31, 36, 0.15); border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; }
        button:hover { background: #2c974b; }
        button:disabled { background: #94d3a2; cursor: not-allowed; }
        #log { margin-top: 20px; padding: 12px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; display: none; }
        .error { background: #ffebe9; color: #cf222e; border: 1px solid rgba(207, 34, 46, 0.15); }
        .success { background: #dafbe1; color: #1a7f37; border: 1px solid rgba(26, 127, 55, 0.15); }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸš€ é…ç½®ç›‘æµ‹ä»»åŠ¡</h3>
        <div class="input-group">
            <label for="urlInput">ç›‘æµ‹ç›®æ ‡ URL</label>
            <input type="text" id="urlInput" placeholder="https://example.com" value="">
        </div>
        <div class="input-group">
            <label for="tokenInput">GitHub Token (Classic)</label>
            <input type="password" id="tokenInput" placeholder="ç²˜è´´ä»¥ ghp_ å¼€å¤´çš„ Token">
        </div>
        <button id="submitBtn" onclick="updateGithub()">åŒæ­¥é…ç½®å¹¶å¼€å§‹ç›‘æµ‹</button>
        <div id="log"></div>
    </div>

    <script>
        // ğŸ› ï¸ èµ„æ·±ç¨‹åºå‘˜æé†’ï¼šè¯·ç¡®ä¿è¿™é‡Œçš„ç”¨æˆ·åä¸ä½ çš„ GitHub ID å®Œå…¨ä¸€è‡´
        const REPO_PATH = "urcedcccc-sketch/web-monitor"; 

        async function updateGithub() {
            const url = document.getElementById('urlInput').value.trim();
            const token = document.getElementById('tokenInput').value.trim();
            const log = document.getElementById('log');
            const btn = document.getElementById('submitBtn');

            if (!url || !token) {
                showLog("è¯·å¡«å†™å®Œæ•´çš„ URL å’Œ Token", "error");
                return;
            }

            btn.disabled = true;
            showLog("æ­£åœ¨è¿æ¥ GitHub API...", "success");

            try {
                // 1. è·å– url.txt çš„æœ€æ–°çŠ¶æ€ (sha)
                const getRes = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/url.txt`, {
                    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" }
                });

                if (!getRes.ok) {
                    const errData = await getRes.json();
                    throw new Error(`è¯»å–å¤±è´¥(${getRes.status}): ${errData.message}`);
                }

                const fileData = await getRes.json();
                const sha = fileData.sha;

                // 2. å¯¹ URL è¿›è¡Œ Base64 ç¼–ç ï¼ˆè§£å†³ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
                const encodedUrl = btoa(unescape(encodeURIComponent(url)));

                // 3. æäº¤æ›´æ–°
                const putRes = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/url.txt`, {
                    method: "PUT",
                    headers: { 
                        "Authorization": `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: "web: update monitor target",
                        content: encodedUrl,
                        sha: sha
                    })
                });

                if (putRes.ok) {
                    showLog("âœ… é…ç½®å·²æˆåŠŸåŒæ­¥åˆ° GitHubï¼\nActions ç›‘æµ‹ä»»åŠ¡å°†åœ¨ 5 åˆ†é’Ÿå†…è‡ªåŠ¨è§¦å‘ã€‚", "success");
                } else {
                    const errData = await putRes.json();
                    throw new Error(`å†™å…¥å¤±è´¥(${putRes.status}): ${errData.message}`);
                }

            } catch (e) {
                showLog("âŒ è¿è¡Œå‡ºé”™ï¼š\n" + e.message + "\n\næ’æŸ¥å»ºè®®ï¼š\n1. æ£€æŸ¥ Token æ˜¯å¦å‹¾é€‰ 'repo' æƒé™\n2. ç¡®è®¤ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨ url.txt", "error");
            } finally {
                btn.disabled = false;
            }
        }

        function showLog(msg, type) {
            log.style.display = "block";
            log.className = type;
            log.innerText = msg;
        }
    </script>
</body>
</html>
